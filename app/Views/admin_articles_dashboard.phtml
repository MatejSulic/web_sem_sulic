<div class="container-fluid mt-4">
    <h2 class="mb-4">Spr√°va ƒçl√°nk≈Ø a recenzn√≠ho ≈ô√≠zen√≠</h2>

    <?php if (isset($_GET['msg'])): ?>
        <div class="alert alert-success alert-dismissible fade show">
            Akce byla √∫spƒõ≈°nƒõ provedena.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <?php endif; ?>

    <div class="row g-3">
        <?php foreach ($articles as $article): ?>
            <div class="col-12 col-md-6 col-xl-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column">

                        <!-- Hlaviƒçka: n√°zev + ID + stav -->
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong class="d-block text-truncate" style="max-width: 260px;">
                                    <?= htmlspecialchars($article->title) ?>
                                </strong>
                                <small class="text-muted d-block">
                                    Autor: <?= htmlspecialchars($article->author_name) ?>
                                </small>
                            </div>

                            <div class="text-end">
                                <span class="badge bg-dark mb-1">ID <?= $article->id ?></span><br>

                                <?php
                                    $statusClass = 'bg-warning text-dark';
                                    $statusText  = 'ƒåEK√Å NA ROZHODNUT√ç';

                                    if ($article->status == 'accepted') {
                                        $statusClass = 'bg-success';
                                        $statusText  = 'SCHV√ÅLENO';
                                    } elseif ($article->status == 'rejected') {
                                        $statusClass = 'bg-danger';
                                        $statusText  = 'ZAM√çTNUTO';
                                    }
                                ?>
                                <span class="badge <?= $statusClass ?>"><?= $statusText ?></span>
                            </div>
                        </div>

                        <!-- PDF odkaz -->
                        <p class="mb-2">
                            <a href="uploads/<?= htmlspecialchars($article->filename) ?>"
                               target="_blank"
                               class="text-decoration-none small">
                                üìÑ Zobrazit PDF
                            </a>
                        </p>

                        <!-- Recenzenti -->
                        <div class="mb-2">
                            <strong class="small d-block mb-1">Recenzenti:</strong>

                            <?php if (empty($article->reviews)): ?>
                                <span class="text-muted small">
                                    <i class="text-danger">‚ö† Zat√≠m nikdo nep≈ôi≈ôazen</i>
                                </span>
                            <?php else: ?>
                                <div class="d-flex flex-wrap gap-1">
                                    <?php foreach ($article->reviews as $r): ?>
                                        <?php $isDone = $r->score_technical > 0; ?>
                                        <span class="badge border <?= $isDone ? 'bg-success' : 'bg-light text-dark border-secondary' ?>"
                                              title="<?= $isDone ? 'Ohodnoceno' : 'ƒåek√° na hodnocen√≠' ?>">
                                            <?= htmlspecialchars($r->reviewer_name) ?>
                                            <?= $isDone ? '‚úî' : '‚è≥' ?>
                                        </span>
                                    <?php endforeach; ?>
                                </div>
                            <?php endif; ?>
                        </div>

                        <!-- P≈ôid√°n√≠ recenzenta (jen pokud pending) -->
                        <?php if ($article->status == 'pending'): ?>
                            <form action="index.php?page=admin-assign"
                                  method="post"
                                  class="mb-3">
                                <input type="hidden" name="article_id" value="<?= $article->id ?>">

                                <div class="d-flex gap-2">
                                    <select name="reviewer_id"
                                            class="form-select form-select-sm"
                                            required>
                                        <option value="" disabled selected>+ P≈ôidat recenzenta...</option>
                                        <?php foreach ($reviewers as $rev): ?>
                                            <option value="<?= $rev->id ?>">
                                                <?= htmlspecialchars($rev->username) ?>
                                            </option>
                                        <?php endforeach; ?>
                                    </select>

                                    <button type="submit"
                                            class="btn btn-sm btn-outline-secondary">
                                        P≈ôidat
                                    </button>
                                </div>
                            </form>
                        <?php endif; ?>

                        <!-- Spodek karty: akce + souhrn -->
                        <div class="mt-auto">
                            <div class="d-grid mb-2">
                                <a href="index.php?page=admin-article-detail&id=<?= $article->id ?>"
                                   class="btn btn-primary btn-sm">
                                    <?php if ($article->status == 'pending'): ?>
                                        ‚öñÔ∏è Detail & Rozhodnout
                                    <?php else: ?>
                                        üîç Zobrazit detail
                                    <?php endif; ?>
                                </a>
                            </div>

                            <div class="text-center small text-muted">
                                Hotov√© recenze:
                                <strong><?= $article->finished_reviews ?></strong>
                                / <?= count($article->reviews) ?>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        <?php endforeach; ?>
    </div>
</div>
